<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>PANOPTICON v3.5 - Analyst Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0a0c10; --panel: #12151a; --border: #2d333b; --text: #adbac7; --purple: #bc8cff; --blue: #539bf5; --green: #57ab5a; --orange: #f69d50; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { padding: 10px 20px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        
        #pulse-chart { height: 80px; background: #000; border-bottom: 1px solid var(--border); }
        #console-wrapper { flex: 1; overflow-y: auto; position: relative; }
        #console { position: absolute; top: 0; left: 0; right: 0; bottom: 0; }

        .log-row { display: flex; gap: 10px; padding: 4px 15px; font-size: 13px; line-height: 1.6; font-family: 'JetBrains Mono', monospace; }
        .log-row.RTP_METRIC { color: var(--purple); }
        .log-row.SIP_TRAFFIC { color: #8ec2ff; }
    </style>
</head>
<body>
    <main>
        <header>
            <h2 style="margin:0; font-size:16px;">üëÅÔ∏è PANOPTICON v3.5</h2>
            <div style="display:flex; gap:20px; font-family: 'JetBrains Mono';">
                <span>PPS: <b id="pps-val" style="color:var(--purple)">0</b></span>
                <span>NODE: <b id="node-val" style="color:var(--orange)">-</b></span>
            </div>
        </header>

        <div id="pulse-chart"><canvas id="canvas"></canvas></div>
        <div id="console-wrapper"><div id="console"></div></div>
    </main>

    <script>
        const consoleWrapper = document.getElementById('console-wrapper');
        const consoleEl = document.getElementById('console');
        const ppsEl = document.getElementById('pps-val');
        const nodeEl = document.getElementById('node-val');
        
        let allLogs = [];
        let viewLogs = [];
        const ROW_HEIGHT = 25;
        let ws;

        function connect() {
            ws = new WebSocket(`ws://${window.location.host}/ws`);
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                processEvent(data);
            };
            ws.onclose = () => setTimeout(connect, 2000);
        }

        function processEvent(data) {
            allLogs.push(data);
            if (allLogs.length > 5000) allLogs.shift();

            const attr = data.Attributes || {};
            if (attr.event === 'RTP_METRIC') {
                ppsEl.innerText = attr.pps;
                updateChart(attr.pps);
            }
            nodeEl.innerText = data.Resource['host.name'];

            updateView();
        }

        // Virtual Scrolling Logic
        function updateView() {
            const scrollTop = consoleWrapper.scrollTop;
            const startIndex = Math.floor(scrollTop / ROW_HEIGHT);
            const visibleRows = Math.ceil(consoleWrapper.clientHeight / ROW_HEIGHT);
            const endIndex = startIndex + visibleRows + 5; // Buffer for smooth scrolling

            viewLogs = allLogs.slice(Math.max(0, startIndex), Math.min(allLogs.length, endIndex));
            
            consoleEl.style.height = `${allLogs.length * ROW_HEIGHT}px`;
            consoleEl.style.paddingTop = `${startIndex * ROW_HEIGHT}px`;

            consoleEl.innerHTML = viewLogs.map(log => {
                const attr = log.Attributes || {};
                return `<div class="log-row ${attr.event || ''}" style="height:${ROW_HEIGHT}px;">
                    <span style="min-width:90px; color:#666;">${new Date(log.Timestamp).toLocaleTimeString()}</span>
                    <span style="min-width:140px; color:var(--orange);">${log.Resource['host.name']}</span>
                    <span style="min-width:130px; color:var(--blue);">${log.Resource['service.name']}</span>
                    <span>${log.Body}</span>
                </div>`;
            }).join('');
        }

        // Pulse Chart
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let chartData = new Array(150).fill(0);
        function updateChart(pps) { chartData.push(pps); chartData.shift(); }
        
        function draw() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx.clearRect(0,0, canvas.width, canvas.height);
            ctx.strokeStyle = 'rgba(188, 140, 255, 0.8)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            const step = canvas.width / (chartData.length - 1);
            chartData.forEach((val, i) => {
                const x = i * step;
                const y = canvas.height - (Math.min(val / 10, canvas.height - 5)); // Scale value
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
            ctx.stroke();
            requestAnimationFrame(draw);
        }

        consoleWrapper.addEventListener('scroll', updateView);
        window.addEventListener('resize', updateView);
        
        connect();
        draw();
    </script>
</body>
</html>