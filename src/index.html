<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>SENTIRIC PANOPTICON v3.2</title>
    <style>
        :root { --bg: #0a0c10; --panel: #12151a; --border: #2d333b; --text: #adbac7; --purple: #bc8cff; --blue: #539bf5; --green: #57ab5a; --orange: #f69d50; }
        body { background: var(--bg); color: var(--text); font-family: 'JetBrains Mono', 'Fira Code', monospace; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        #sidebar { width: 260px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: 0.3s; }
        #sidebar.collapsed { margin-left: -260px; }
        
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { padding: 10px 20px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        
        #console { flex: 1; overflow-y: auto; padding: 10px; font-size: 12px; line-height: 1.5; }
        .row { display: flex; gap: 10px; padding: 3px 8px; border-bottom: 1px solid #1c2128; border-left: 4px solid transparent; }
        .row.RTP_FLOW { border-left-color: var(--purple); color: #d4bbff; }
        .row.SIP_TRAFFIC { border-left-color: var(--blue); color: #8ec2ff; }
        
        .c-ts { color: #636e7b; min-width: 85px; }
        .c-node { color: var(--orange); min-width: 140px; font-weight: bold; }
        .c-svc { color: var(--blue); min-width: 130px; }
        .c-body { flex: 1; white-space: pre-wrap; word-break: break-all; }

        #pulse-box { height: 60px; background: #000; margin: 10px; border: 1px solid var(--border); position: relative; }
        canvas { width: 100%; height: 100%; }
        
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; background: #238636; color: white; }
    </style>
</head>
<body>
    <aside id="sidebar">
        <div style="padding:20px;">
            <h3 style="font-size:14px;">üõ†Ô∏è KONTROL PANELƒ∞</h3>
            <input type="text" id="filter" placeholder="Filtrele..." onkeyup="updateView()" style="width:100%; background:black; border:1px solid var(--border); color:white; padding:8px;">
            <div id="svc-list" style="margin-top:20px; font-size:12px;"></div>
            <button onclick="exportLogs()" style="margin-top:20px; width:100%; padding:10px; cursor:pointer;">üì• LOGLARI AKTAR</button>
        </div>
    </aside>

    <main>
        <header>
            <div style="display:flex; align-items:center; gap:15px;">
                <button onclick="document.getElementById('sidebar').classList.toggle('collapsed')">‚ò∞</button>
                <h2 style="margin:0; font-size:16px;">üëÅÔ∏è PANOPTICON v3.2</h2>
                <div class="badge">LIVE</div>
            </div>
            <div style="display:flex; gap:20px; font-size:13px;">
                <span>PPS: <b id="pps-val" style="color:var(--purple)">0</b></span>
                <span>Node: <b id="host-val" style="color:var(--orange)">-</b></span>
            </div>
        </header>

        <div id="pulse-box"><canvas id="canvas"></canvas></div>

        <div id="console"></div>
    </main>

    <script>
        const consoleEl = document.getElementById('console');
        const ppsEl = document.getElementById('pps-val');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        let pps = 0;
        let ppsHistory = new Array(100).fill(0);
        let logHistory = [];
        let discoveredServices = new Set();

        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            const attr = data.Attributes || {};
            
            // Metrics
            if (attr.event === "RTP_FLOW") pps += 25; // Sampling rate multiplier
            document.getElementById('host-val').innerText = data.Resource['host.name'];

            // Discovery
            const svc = data.Resource['service.name'];
            if (!discoveredServices.has(svc)) {
                discoveredServices.add(svc);
                updateSvcList();
            }

            // Log History
            logHistory.push(data);
            if (logHistory.length > 2000) logHistory.shift();

            renderRow(data);
        };

        function renderRow(data) {
            const attr = data.Attributes || {};
            const row = document.createElement('div');
            row.className = `row ${attr.event || ''}`;
            
            const ts = new Date(data.Timestamp).toLocaleTimeString();
            row.innerHTML = `
                <div class="c-ts">${ts}</div>
                <div class="c-node">${data.Resource['host.name']}</div>
                <div class="c-svc">${data.Resource['service.name']}</div>
                <div class="c-body">${data.Body}</div>
            `;
            consoleEl.appendChild(row);
            if (consoleEl.children.length > 500) consoleEl.removeChild(consoleEl.firstChild);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function updateSvcList() {
            const list = document.getElementById('svc-list');
            list.innerHTML = '<b>Servisler:</b><br>' + Array.from(discoveredServices).join('<br>');
        }

        function exportLogs() {
            const blob = new Blob([JSON.stringify(logHistory, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `panopticon_${Date.now()}.json`;
            a.click();
        }

        // Pulse Chart Animation
        function draw() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ppsHistory.push(pps);
            ppsHistory.shift();
            ppsEl.innerText = pps;
            pps = 0;

            ctx.clearRect(0,0, canvas.width, canvas.height);
            ctx.strokeStyle = '#bc8cff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            const step = canvas.width / 99;
            ppsHistory.forEach((v, i) => {
                const x = i * step;
                const y = canvas.height - (Math.min(v/5, canvas.height-5));
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            });
            ctx.stroke();
            setTimeout(draw, 100);
        }
        draw();
    </script>
</body>
</html>