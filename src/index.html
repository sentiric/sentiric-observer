<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTIRIC | INTELLIGENT OBSERVER</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <!-- Mermaid JS -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root { --primary: #00ff9d; --bg: #050505; --panel: #111; --text: #e0e0e0; --remote: #00d4ff; --mobile: #ff00ff; --warn: #ffae00; --error: #ff4444; --sip: #00d4ff; }
        body { background: var(--bg); color: var(--text); font-family: 'Consolas', monospace; margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Layout */
        #main-container { display: flex; flex: 1; overflow: hidden; }
        #log-panel { flex: 2; border-right: 1px solid #333; display: flex; flex-direction: column; min-width: 0; }
        #diagram-panel { flex: 1; background: #0e0e0e; padding: 20px; display: none; flex-direction: column; border-left: 1px solid #333; min-width: 400px; }
        
        /* Header */
        header { background: #000; padding: 10px 20px; border-bottom: 1px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .brand { font-weight: bold; letter-spacing: 1px; color: var(--primary); }
        
        /* Stats Bar (RESTORED) */
        #stats-bar { display: flex; gap: 15px; font-size: 11px; }
        .stat-box { background: #111; border: 1px solid #333; padding: 4px 10px; border-radius: 4px; display: flex; gap: 5px; }
        .stat-label { color: #666; }
        .stat-val { font-weight: bold; color: var(--primary); }
        .stat-warn { color: var(--warn); }
        
        /* Toolbar */
        #toolbar { background: var(--panel); padding: 8px 15px; border-bottom: 1px solid #333; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .tool-group { display: flex; align-items: center; gap: 8px; border-right: 1px solid #333; padding-right: 15px; }
        button { background: #222; border: 1px solid #444; color: #aaa; padding: 4px 10px; cursor: pointer; border-radius: 3px; font-size: 11px; }
        button:hover { background: #333; color: #fff; }
        button.active { border-color: var(--primary); color: var(--primary); background: rgba(0, 255, 157, 0.1); }
        input { background: #000; border: 1px solid #444; color: var(--primary); padding: 4px; font-size: 11px; width: 200px; }

        /* Console */
        #console { flex: 1; overflow-y: auto; padding: 10px; font-size: 12px; scroll-behavior: smooth; }
        .line { margin-bottom: 2px; padding: 2px 5px; border-bottom: 1px solid #111; white-space: pre-wrap; word-break: break-all; border-left: 3px solid transparent; }
        .line:hover { background: #1a1a1a; }
        
        /* Highlighting */
        .type-local { border-left-color: var(--primary); }
        .type-remote { border-left-color: var(--remote); }
        .type-mobile { border-left-color: var(--mobile); }
        .hl-sip { color: var(--sip); background: #00d4ff05; }
        .hl-err { color: var(--error); font-weight: bold; background: #ff444411; }
        .hl-warn { color: var(--warn); }
        
        /* Tags */
        .tag { padding: 1px 4px; border-radius: 2px; margin-right: 5px; font-weight: bold; font-size: 10px; }
        .tag-loc { background: #004400; color: var(--primary); }
        .tag-rem { background: #002244; color: var(--remote); }
        .tag-mob { background: #440044; color: var(--mobile); }

        /* Interactive Elements */
        .call-id { color: var(--warn); background: #221100; padding: 0 4px; border-radius: 3px; cursor: pointer; text-decoration: underline; }
        .call-id:hover { background: var(--warn); color: #000; }

        /* Diagram */
        #mermaid-chart { flex: 1; overflow: auto; padding-top: 20px; }
        .diagram-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
        
        #ws-status { font-size: 10px; display: flex; align-items: center; gap: 5px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ff4444; }
        .dot.online { background: var(--primary); box-shadow: 0 0 5px var(--primary); }
    </style>
</head>
<body>
    <header>
        <div class="brand">üëÅÔ∏è SENTIRIC <span style="color:#fff">OBSERVER</span> PRO</div>
        
        <!-- RESTORED STATS BAR -->
        <div id="stats-bar">
            <div class="stat-box"><span class="stat-label">JITTER</span><span id="v-jitter" class="stat-val">--</span></div>
            <div class="stat-box"><span class="stat-label">LOSS</span><span id="v-loss" class="stat-val">0%</span></div>
            <div class="stat-box"><span class="stat-label">MOB-RX</span><span id="v-rx" class="stat-val">0</span></div>
            <div class="stat-box"><span class="stat-label">MOB-TX</span><span id="v-tx" class="stat-val">0</span></div>
        </div>

        <div id="ws-status">
            <div id="status-dot" class="dot"></div>
            <span id="status-text">OFFLINE</span>
        </div>
    </header>

    <div id="main-container">
        <!-- SOL PANEL: LOGLAR -->
        <div id="log-panel">
            <div id="toolbar">
                <div class="tool-group">
                    <button id="btn-local" class="active" onclick="toggleFilter('local')">üìç LOCAL</button>
                    <button id="btn-remote" class="active" onclick="toggleFilter('remote')">üåç REMOTE</button>
                    <button id="btn-mobile" class="active" onclick="toggleFilter('mobile')">üì± MOBILE</button>
                </div>
                <div class="tool-group">
                    <button id="btn-sip" class="active" onclick="toggleFilter('sip')">SIP</button>
                    <button id="btn-logs" class="active" onclick="toggleFilter('logs')">LOGS</button>
                </div>
                <div class="tool-group">
                    <input type="text" id="search" placeholder="Filter / Click Call-ID..." oninput="applyFilters()">
                    <button onclick="clearLogs()">CLEAR</button>
                    <button onclick="toggleScroll()" id="btn-scroll" class="active">SCROLL</button>
                </div>
            </div>
            <div id="console"></div>
        </div>

        <!-- SAƒû PANEL: Dƒ∞YAGRAM -->
        <div id="diagram-panel">
            <div class="diagram-header">
                <span style="color:var(--primary); font-weight:bold;">CALL FLOW SEQUENCE</span>
                <button onclick="closeDiagram()">CLOSE</button>
            </div>
            <div id="mermaid-chart"></div>
        </div>
    </div>

    <script>
        mermaid.initialize({ startOnLoad: false, theme: 'dark', securityLevel: 'loose' });

        const consoleEl = document.getElementById('console');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws`);
        
        let logs = []; 
        let config = { local: true, remote: true, mobile: true, sip: true, logs: true, scroll: true, maxLines: 2000 };
        let currentFilter = "";

        ws.onopen = () => { statusDot.className = 'dot online'; statusText.innerText = 'LIVE'; };
        ws.onclose = () => { statusDot.className = 'dot'; statusText.innerText = 'OFFLINE'; };

        ws.onmessage = (e) => {
            const raw = e.data;
            logs.push(raw); 
            if (logs.length > 5000) logs.shift(); 

            // [RESTORED] Stats Parsing
            if (raw.includes("RtpStats") || (raw.includes("Loss:") && raw.includes("Jitter:"))) {
                updateStatsUI(raw);
                // Eƒüer log filtresi kapalƒ±ysa istatistik paketini konsola basma, sadece widget g√ºncelle
                if (!config.logs) return; 
            }

            renderLine(raw);
        };

        function renderLine(raw) {
            const isLocal = raw.includes("üìç") || raw.includes("üè†");
            const isRemote = raw.includes("üåç") || raw.includes("üåê");
            const isMobile = raw.includes("üì±") || raw.includes("MOBILE-SDK");
            const isSip = /INVITE|ACK|BYE|CANCEL|OPTIONS|REGISTER|200 OK|100 Trying|180 Ringing/.test(raw);
            const isError = /ERROR|Fail|Critical|Timeout/.test(raw);

            if (isLocal && !config.local) return;
            if (isRemote && !config.remote) return;
            if (isMobile && !config.mobile) return;
            
            // Content Filter
            if (isSip && !config.sip) return;
            if (!isSip && !config.logs) return;

            if (currentFilter && !raw.toLowerCase().includes(currentFilter.toLowerCase())) return;

            const div = document.createElement('div');
            div.className = 'line';
            
            if (isLocal) div.classList.add('type-local');
            if (isRemote) div.classList.add('type-remote');
            if (isMobile) div.classList.add('type-mobile');
            if (isSip) div.classList.add('hl-sip');
            if (isError) div.classList.add('hl-err');

            let html = raw.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            
            // Tags
            if (isLocal) html = html.replace("üìç", '<span class="tag tag-loc">LOC</span>');
            if (isRemote) html = html.replace("üåç", '<span class="tag tag-rem">REM</span>').replace("üåê", '<span class="tag tag-rem">REM</span>');
            if (isMobile) html = html.replace("üì±", '<span class="tag tag-mob">MOB</span>');

            // [NEW] Interactive Call-ID
            html = html.replace(/(uac-[a-f0-9]+)/g, '<span class="call-id" onclick="openDiagram(\'$1\')">$1</span>');

            div.innerHTML = html;
            consoleEl.appendChild(div);

            if (config.scroll) consoleEl.scrollTop = consoleEl.scrollHeight;
            if (consoleEl.childElementCount > config.maxLines) consoleEl.removeChild(consoleEl.firstChild);
        }

        function updateStatsUI(raw) {
            const jitter = raw.match(/Jitter: ([\d.]+)ms/);
            const loss = raw.match(/Loss: ([\d.]+)%/);
            const rx = raw.match(/rx_cnt: (\d+)/);
            const tx = raw.match(/tx_cnt: (\d+)/);

            if (jitter) {
                const el = document.getElementById('v-jitter');
                const val = parseFloat(jitter[1]);
                el.innerText = val.toFixed(2) + ' ms';
                el.className = val > 30 ? 'stat-val stat-warn' : 'stat-val';
            }
            if (loss) document.getElementById('v-loss').innerText = loss[1] + '%';
            if (rx) document.getElementById('v-rx').innerText = rx[1];
            if (tx) document.getElementById('v-tx').innerText = tx[1];
        }

        // --- DIAGRAM LOGIC ---
        function openDiagram(callId) {
            document.getElementById('search').value = callId;
            currentFilter = callId;
            applyFilters(); // Konsolu da filtrele
            
            const panel = document.getElementById('diagram-panel');
            panel.style.display = 'flex';
            
            generateDiagram(callId);
        }

        function generateDiagram(callId) {
            let graphDefinition = 'sequenceDiagram\n';
            let participants = new Set();
            let hasData = false;

            logs.filter(l => l.includes(callId)).forEach(line => {
                let src = "Unknown", dst = "Unknown", msg = "Message";

                // Heuristic Parsing
                if (line.includes("MOBILE")) src = "Mobile";
                else if (line.includes("SBC")) src = "SBC";
                else if (line.includes("PROXY")) src = "Proxy";
                else if (line.includes("B2BUA")) src = "B2BUA";
                else if (line.includes("MEDIA")) src = "Media";
                else return;

                // Message Type
                if (line.includes("INVITE")) msg = "INVITE";
                else if (line.includes("200 OK")) msg = "200 OK";
                else if (line.includes("ACK")) msg = "ACK";
                else if (line.includes("BYE")) msg = "BYE";
                else if (line.includes("Trying")) msg = "100 Trying";
                else if (line.includes("Ringing")) msg = "180 Ringing";
                else return;

                // Direction Logic
                if (line.includes("OUTGOING") || line.includes("SENDING")) {
                    if (src === "Mobile") dst = "SBC";
                    else if (src === "SBC") dst = "Proxy";
                    else if (src === "Proxy") dst = "B2BUA";
                    graphDefinition += `${src}->>${dst}: ${msg}\n`;
                    hasData = true;
                } else if (line.includes("RECEIVED") || line.includes("INCOMING")) {
                    // Gelen mesajlarƒ± "Note" olarak ekleyebiliriz veya akƒ±≈üƒ± tersine √ßevirebiliriz
                    // Basitlik i√ßin note kullanalƒ±m
                    graphDefinition += `Note right of ${src}: üì• ${msg}\n`;
                    hasData = true;
                }
            });

            const element = document.getElementById('mermaid-chart');
            element.removeAttribute('data-processed');
            element.innerHTML = hasData ? graphDefinition : "No SIP flow detected.";
            if (hasData) mermaid.init(undefined, element);
        }

        function closeDiagram() {
            document.getElementById('diagram-panel').style.display = 'none';
        }

        // --- Controls ---
        function toggleFilter(key) {
            config[key] = !config[key];
            document.getElementById('btn-' + key).classList.toggle('active');
            // Re-render (Clean console first)
            consoleEl.innerHTML = "";
            logs.forEach(renderLine);
        }
        function toggleScroll() {
            config.scroll = !config.scroll;
            document.getElementById('btn-scroll').classList.toggle('active');
        }
        function clearLogs() {
            consoleEl.innerHTML = "";
            logs = [];
        }
        function applyFilters() {
            currentFilter = document.getElementById('search').value;
            consoleEl.innerHTML = "";
            logs.forEach(renderLine);
        }
    </script>
</body>
</html>