<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTIRIC | FLIGHT RECORDER v5.0</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505; --panel: #0f0f0f; --text: #c0c0c0; --border: #222;
            --sip: #00d4ff; --rtp: #bd00ff; --sys: #00ff9d; --err: #ff4444; --warn: #ffae00;
        }
        body { background: var(--bg); color: var(--text); font-family: 'JetBrains Mono', monospace; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 12px; }
        
        /* HEADER */
        header { background: #000; height: 48px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        .brand { font-weight: 800; letter-spacing: 1px; color: #fff; }
        .brand span { color: var(--sys); }
        .live-dot { height: 8px; width: 8px; background: var(--err); border-radius: 50%; display: inline-block; margin-right: 5px; }
        .live-dot.on { background: var(--sys); box-shadow: 0 0 8px var(--sys); }

        /* TOOLBAR */
        #toolbar { background: var(--panel); padding: 8px 15px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; }
        .filter-group { display: flex; gap: 4px; padding-right: 10px; border-right: 1px solid #333; }
        
        button { background: #1a1a1a; border: 1px solid #333; color: #777; padding: 4px 10px; font-family: inherit; font-size: 11px; cursor: pointer; border-radius: 3px; transition: 0.2s; }
        button:hover { border-color: #555; color: #fff; }
        button.active { background: #222; color: #fff; border-color: #555; font-weight: bold; }
        
        button.type-sip.active { border-color: var(--sip); color: var(--sip); background: rgba(0, 212, 255, 0.1); }
        button.type-rtp.active { border-color: var(--rtp); color: var(--rtp); background: rgba(189, 0, 255, 0.1); }
        button.type-sys.active { border-color: var(--sys); color: var(--sys); background: rgba(0, 255, 157, 0.1); }
        
        .action-btn { border-color: var(--warn); color: var(--warn); font-weight: bold; margin-left: auto; }
        .action-btn:hover { background: var(--warn); color: #000; }

        /* CONSOLE */
        #console { flex: 1; overflow-y: auto; padding: 10px; scroll-behavior: smooth; }
        .log-row { display: flex; gap: 10px; padding: 2px 4px; border-radius: 2px; font-size: 11px; line-height: 1.4; border-left: 2px solid transparent; }
        .log-row:hover { background: rgba(255,255,255,0.03); }
        
        .ts { min-width: 70px; color: #555; }
        .svc { min-width: 120px; font-weight: bold; color: #777; }
        .msg { flex: 1; white-space: pre-wrap; word-break: break-all; }

        /* Log Colors */
        .row-sip { border-left-color: var(--sip); } .row-sip .svc { color: var(--sip); }
        .row-rtp { border-left-color: var(--rtp); } .row-rtp .svc { color: var(--rtp); }
        .row-sys { border-left-color: var(--sys); } .row-sys .svc { color: var(--sys); }
        .row-err { border-left-color: var(--err); background: rgba(255, 68, 68, 0.05); } .row-err .msg { color: var(--err); }
        .row-def .svc { color: #aaa; }

    </style>
</head>
<body>
    <header>
        <div class="brand">SENTIRIC <span>FLIGHT RECORDER</span></div>
        <div style="font-size:10px; color:#555;">
            <span id="status-dot" class="live-dot"></span> <span id="status-txt">OFFLINE</span>
            | BUFFER: <span id="buf-len">0</span>
        </div>
    </header>

    <div id="toolbar">
        <!-- Otomatik Oluşan Butonlar Buraya -->
        <div id="dynamic-filters" class="filter-group"></div>
        
        <!-- Sabit Kontroller -->
        <div class="filter-group">
            <button onclick="togglePause()" id="btn-pause">PAUSE</button>
            <button onclick="clearLogs()">CLEAR</button>
        </div>

        <button class="action-btn" onclick="downloadJson()">⬇ DOWNLOAD JSON</button>
    </div>

    <div id="console"></div>

    <script>
        const consoleEl = document.getElementById('console');
        const filterContainer = document.getElementById('dynamic-filters');
        
        let allLogs = []; // Tüm logları hafızada tut (Export için)
        let isPaused = false;
        let activeServices = new Set(); // Hangi servisler görünür?
        let knownServices = new Set();  // Hangi servisleri tanıdık?

        // WebSocket Bağlantısı
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        
        ws.onopen = () => {
            document.getElementById('status-dot').classList.add('on');
            document.getElementById('status-txt').innerText = "CONNECTED";
        };

        ws.onmessage = (event) => {
            if (isPaused) return;
            try {
                const entry = JSON.parse(event.data);
                allLogs.push(entry);
                if (allLogs.length > 5000) allLogs.shift(); // Hafıza koruması
                document.getElementById('buf-len').innerText = allLogs.length;
                
                registerService(entry.service);
                
                // Eğer filtresi aktifse ekrana bas
                if (activeServices.has(entry.service)) {
                    renderRow(entry);
                }
            } catch (e) { console.error(e); }
        };

        function registerService(svcName) {
            if (knownServices.has(svcName)) return;
            knownServices.add(svcName);
            
            // Varsayılan olarak hepsini aktif et
            activeServices.add(svcName);

            const btn = document.createElement('button');
            btn.innerText = svcName;
            btn.className = 'active';
            
            // Özel Stil Atamaları
            if (svcName.includes('SIP')) btn.classList.add('type-sip');
            else if (svcName.includes('RTP')) btn.classList.add('type-rtp');
            else if (svcName.includes('SYSTEM')) btn.classList.add('type-sys');

            btn.onclick = () => {
                if (activeServices.has(svcName)) {
                    activeServices.delete(svcName);
                    btn.classList.remove('active');
                } else {
                    activeServices.add(svcName);
                    btn.classList.add('active');
                }
                // Ekranı tazele (Filtre değiştiği için)
                redrawConsole();
            };
            filterContainer.appendChild(btn);
        }

        function renderRow(entry) {
            const div = document.createElement('div');
            let cssClass = 'row-def';
            
            if (entry.service === 'SNIFFER-SIP') cssClass = 'row-sip';
            else if (entry.service === 'SNIFFER-RTP') cssClass = 'row-rtp';
            else if (entry.service === 'SYSTEM') cssClass = 'row-sys';
            else if (entry.level === 'ERROR') cssClass = 'row-err';

            div.className = `log-row ${cssClass}`;
            
            // Timestamp formatla (HH:MM:SS)
            const time = entry.ts.split('T')[1].split('.')[0];
            
            div.innerHTML = `
                <div class="ts">${time}</div>
                <div class="svc">${entry.service}</div>
                <div class="msg">${entry.msg}</div>
            `;
            
            consoleEl.appendChild(div);
            
            // Otomatik kaydır
            if (consoleEl.childElementCount > 1000) consoleEl.removeChild(consoleEl.firstChild);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function redrawConsole() {
            consoleEl.innerHTML = '';
            // Hafızadaki son 1000 logu filtreye göre yeniden çiz
            const slice = allLogs.slice(-1000);
            slice.forEach(entry => {
                if (activeServices.has(entry.service)) renderRow(entry);
            });
        }

        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('btn-pause').innerText = isPaused ? "RESUME" : "PAUSE";
            document.getElementById('btn-pause').style.color = isPaused ? "var(--warn)" : "";
        }

        function clearLogs() {
            consoleEl.innerHTML = '';
            // Hafızayı silmiyoruz, sadece ekranı temizliyoruz.
            // Tam reset için: allLogs = [];
        }

        function downloadJson() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allLogs, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `sentiric_logs_${new Date().toISOString()}.json`);
            document.body.appendChild(downloadAnchorNode); // Firefox için gerekli
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>
</body>
</html>