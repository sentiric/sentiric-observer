<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTIRIC | COCKPIT PRO v3.5</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <!-- Mermaid JS Core -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root { 
            --primary: #00ff9d; --bg: #050505; --panel: #0f0f0f; --text: #d0d0d0; 
            --remote: #00d4ff; --mobile: #d900ff; --warn: #ffae00; --error: #ff4444; 
            --sip: #00d4ff; --border: #222; 
        }
        
        body { background: var(--bg); color: var(--text); font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* High-End Header */
        header { 
            background: #000; padding: 0 20px; height: 55px; border-bottom: 1px solid var(--primary); 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 20px rgba(0,255,157,0.1); z-index: 1000;
        }
        .brand { font-weight: 900; letter-spacing: 2px; color: #fff; display: flex; align-items: center; gap: 8px; }
        .brand span { color: var(--primary); }

        #stats-bar { display: flex; gap: 15px; font-size: 11px; }
        .stat-box { background: #111; border: 1px solid var(--border); padding: 4px 12px; border-radius: 4px; border-left: 3px solid var(--primary); }
        .stat-val { font-weight: bold; color: #fff; margin-left: 5px; }

        /* Toolbar / Control Center */
        #toolbar { background: var(--panel); padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .filter-section { display: flex; gap: 6px; align-items: center; border-right: 1px solid #333; padding-right: 15px; }
        .filter-section:last-child { border: none; }
        .lbl { font-size: 10px; text-transform: uppercase; color: #555; font-weight: 800; letter-spacing: 1px; }

        /* Modern Filter Buttons */
        .f-btn { 
            background: #1a1a1a; border: 1px solid #333; color: #666; padding: 5px 12px; 
            font-size: 11px; cursor: pointer; border-radius: 4px; transition: all 0.2s; font-weight: 600;
        }
        .f-btn:hover { border-color: #555; color: #aaa; }
        .f-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(0, 255, 157, 0.08); }
        .f-btn.active.n-remote { border-color: var(--remote); color: var(--remote); background: rgba(0, 212, 255, 0.08); }
        .f-btn.active.n-mobile { border-color: var(--mobile); color: var(--mobile); background: rgba(217, 0, 255, 0.08); }

        /* Special Action Buttons */
        .export-btn { background: var(--primary); color: #000; border: none; font-weight: 900; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .export-btn:hover { transform: scale(1.05); }

        /* Workspace */
        #workspace { display: flex; flex: 1; overflow: hidden; }
        #console { flex: 2; overflow-y: auto; padding: 15px; background: #080808; position: relative; }
        #diagram-panel { 
            flex: 1.2; background: #0c0c0c; border-left: 1px solid var(--border); 
            display: none; flex-direction: column; padding: 20px; overflow: auto; 
        }

        /* Log Styling */
        .line { 
            margin-bottom: 4px; font-size: 12px; padding: 6px 10px; border-radius: 4px;
            border-left: 3px solid transparent; background: rgba(255,255,255,0.01);
            display: flex; gap: 12px; transition: 0.1s;
        }
        .line:hover { background: rgba(255,255,255,0.04); cursor: pointer; }
        
        .ts { color: #444; min-width: 65px; }
        .node { min-width: 100px; font-weight: bold; font-size: 11px; }
        .svc { color: #777; min-width: 130px; font-size: 11px; }
        .msg { flex: 1; word-break: break-all; color: #bbb; }

        /* Semantic Highlighting */
        .l-local { border-left-color: var(--primary); }
        .l-remote { border-left-color: var(--remote); }
        .l-mobile { border-left-color: var(--mobile); }
        .sip-packet { background: rgba(0, 212, 255, 0.04); color: var(--remote); border-radius: 4px; padding: 10px; margin-top: 5px; border: 1px solid #00d4ff22; font-size: 11px; }
        .call-id { color: var(--warn); font-weight: bold; background: #2a1a00; padding: 1px 5px; border-radius: 3px; cursor: help; }
        
        #ws-status { font-size: 10px; font-weight: bold; }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; background: #ff4444; }
        .dot.online { background: var(--primary); box-shadow: 0 0 8px var(--primary); }
    </style>
</head>
<body>
    <header>
        <div class="brand">SENTIRIC <span>COCKPIT</span> <small style="font-size:9px; margin-left:10px; opacity:0.5;">v3.5 PRO</small></div>
        
        <div id="stats-bar">
            <div class="stat-box">JITTER<span id="v-jitter" class="stat-val">--</span></div>
            <div class="stat-box">LOSS<span id="v-loss" class="stat-val">0%</span></div>
            <div class="stat-box">MB-RX<span id="v-rx" class="stat-val">0</span></div>
            <div class="stat-box">MB-TX<span id="v-tx" class="stat-val">0</span></div>
        </div>

        <div id="ws-status">
            <span id="status-dot" class="dot"></span>
            <span id="status-text">DISCONNECTED</span>
        </div>
    </header>

    <div id="toolbar">
        <div class="filter-section">
            <span class="lbl">Nodes</span>
            <div id="filter-nodes" style="display:flex; gap:5px;"></div>
        </div>
        <div class="filter-section">
            <span class="lbl">Services</span>
            <div id="filter-services" style="display:flex; gap:5px;"></div>
        </div>
        <div class="filter-section">
            <span class="lbl">Search</span>
            <input type="text" id="search" placeholder="Call-ID or keyword..." oninput="refreshView()">
        </div>
        <div class="filter-section">
            <button class="export-btn" onclick="exportFilteredData()">EXPORT (FILTERED)</button>
            <button class="f-btn" id="btn-pause" onclick="togglePause()">PAUSE</button>
            <button class="f-btn" onclick="clearDb()" style="color:var(--error)">PURGE</button>
        </div>
    </div>

    <div id="workspace">
        <div id="console"></div>
        <div id="diagram-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:10px;">
                <b style="color:var(--primary); font-size:12px;">SEQUENCE ANALYZER</b>
                <button class="f-btn" onclick="document.getElementById('diagram-panel').style.display='none'">CLOSE</button>
            </div>
            <div id="mermaid-chart"></div>
        </div>
    </div>

    <script>
        // Mermaid Theme Configuration
        mermaid.initialize({ 
            startOnLoad: false, 
            theme: 'base',
            themeVariables: {
                primaryColor: '#111',
                primaryTextColor: '#fff',
                primaryBorderColor: '#00ff9d',
                lineColor: '#00ff9d',
                secondaryColor: '#002244',
                tertiaryColor: '#111',
                noteBkgColor: '#222',
                noteTextColor: '#00d4ff'
            }
        });

        const consoleEl = document.getElementById('console');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        
        let logs = [];
        let isPaused = false;
        let knownNodes = new Set();
        let knownServices = new Set();
        let activeNodes = new Set();
        let activeServices = new Set();

        // 1. IndexedDB Implementation
        const dbName = "SentiricCockpitDB";
        let db;
        const dbReq = indexedDB.open(dbName, 1);
        dbReq.onupgradeneeded = (e) => e.target.result.createObjectStore("logs", { autoIncrement: true });
        dbReq.onsuccess = (e) => { db = e.target.result; loadHistory(); };

        // 2. Network - WebSocket
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
        ws.onopen = () => { statusDot.className = 'dot online'; statusText.innerText = 'LIVE'; };
        ws.onclose = () => { statusDot.className = 'dot'; statusText.innerText = 'OFFLINE'; };

        ws.onmessage = (e) => {
            if (isPaused) return;
            try {
                const entry = JSON.parse(e.data);
                processEntry(entry, true);
            } catch (err) { /* Silent ignore non-json */ }
        };

        function processEntry(entry, saveToDb) {
            // Discovery Logic
            if (!knownNodes.has(entry.node)) {
                knownNodes.add(entry.node); activeNodes.add(entry.node);
                createFilterBtn('filter-nodes', entry.node, 'node');
            }
            if (!knownServices.has(entry.service)) {
                knownServices.add(entry.service); activeServices.add(entry.service);
                createFilterBtn('filter-services', entry.service, 'svc');
            }

            logs.push(entry);
            if (logs.length > 5000) logs.shift();

            if (saveToDb && db) {
                const tx = db.transaction("logs", "readwrite");
                tx.objectStore("logs").add(entry);
            }

            renderLine(entry);
        }

        function isVisible(entry) {
            if (!activeNodes.has(entry.node)) return false;
            if (!activeServices.has(entry.service)) return false;
            const search = document.getElementById('search').value.toLowerCase();
            if (search && !JSON.stringify(entry).toLowerCase().includes(search)) return false;
            return true;
        }

        function renderLine(entry) {
            if (!isVisible(entry)) return;

            // Handle Stats & Quality Reports
            if (entry.msg.includes("QoS Report")) {
                const jMatch = entry.msg.match(/Jitter: ([\d.]+)ms/);
                const lMatch = entry.msg.match(/Loss: ([\d.]+)%/);
                if (jMatch) document.getElementById('v-jitter').innerText = jMatch[1] + ' ms';
                if (lMatch) document.getElementById('v-loss').innerText = lMatch[1] + '%';
            }
            if (entry.msg.includes("RtpStats")) {
                const rxM = entry.msg.match(/rx_cnt: (\d+)/);
                const txM = entry.msg.match(/tx_cnt: (\d+)/);
                if (rxM) document.getElementById('v-rx').innerText = rxM[1];
                if (txM) document.getElementById('v-tx').innerText = txM[1];
                return; // Don't print raw stats in log console
            }

            const row = document.createElement('div');
            let nodeType = entry.node.includes('GCP') ? 'l-remote' : (entry.node.includes('MOBILE') ? 'l-mobile' : 'l-local');
            row.className = `line ${nodeType}`;

            let cleanMsg = entry.msg.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            
            // Interaction: Call-ID
            cleanMsg = cleanMsg.replace(/(uac-[a-f0-9]+)/g, '<span class="call-id" onclick="focusCall(\'$1\')">$1</span>');

            // SIP Highlighting
            if (cleanMsg.includes("INVITE") || cleanMsg.includes("200 OK") || cleanMsg.includes("ACK")) {
                cleanMsg = `<div class="sip-packet">${cleanMsg}</div>`;
            }

            row.innerHTML = `
                <div class="ts">${entry.ts.split('T')[1].split('.')[0]}</div>
                <div class="node">${entry.node}</div>
                <div class="svc">${entry.service}</div>
                <div class="msg">${cleanMsg}</div>
            `;

            consoleEl.appendChild(row);
            if (!isPaused) consoleEl.scrollTop = consoleEl.scrollHeight;
            if (consoleEl.childElementCount > 1000) consoleEl.removeChild(consoleEl.firstChild);
        }

        function createFilterBtn(containerId, name, type) {
            const btn = document.createElement('button');
            btn.innerText = name;
            btn.className = `f-btn active ${name.includes('GCP') ? 'n-remote' : (name.includes('MOBILE') ? 'n-mobile' : '')}`;
            btn.onclick = () => {
                const set = type === 'node' ? activeNodes : activeServices;
                set.has(name) ? set.delete(name) : set.add(name);
                btn.classList.toggle('active');
                refreshView();
            };
            document.getElementById(containerId).appendChild(btn);
        }

        // [NEW]: Intelligent Filtered Export
        function exportFilteredData() {
            const filtered = logs.filter(isVisible);
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(filtered, null, 2));
            const downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute("href", dataStr);
            downloadAnchor.setAttribute("download", `sentiric_filtered_export_${Date.now()}.json`);
            document.body.appendChild(downloadAnchor);
            downloadAnchor.click();
            downloadAnchor.remove();
        }

        function focusCall(id) {
            document.getElementById('search').value = id;
            refreshView();
            
            document.getElementById('diagram-panel').style.display = 'flex';
            generateFlow(id);
        }

        function generateFlow(callId) {
            let diag = "sequenceDiagram\n";
            diag += "autonumber\n";
            let participants = new Set();
            
            logs.filter(l => JSON.stringify(l).includes(callId)).forEach(l => {
                let msg = l.msg.includes("INVITE") ? "INVITE" : (l.msg.includes("200 OK") ? "200 OK" : (l.msg.includes("ACK") ? "ACK" : "BYE"));
                if (!["INVITE", "200 OK", "ACK", "BYE"].some(v => l.msg.includes(v))) return;

                let src = l.service.replace("-SERVICE", "");
                if (l.node.includes("MOBILE")) src = "MOBILE";
                
                // Direction Heuristic
                let target = src
             

                diag += `${src}->>+${target}: ${msg}\n`;
            });

            const el = document.getElementById('mermaid-chart');
            el.removeAttribute('data-processed');
            el.innerHTML = diag;
            mermaid.init(undefined, el);
        }

        function loadHistory() {
            const tx = db.transaction("logs", "readonly");
            const store = tx.objectStore("logs");
            store.openCursor(null, 'prev').onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor && logs.length < 500) {
                    processEntry(cursor.value, false);
                    cursor.continue();
                }
            };
        }

        function togglePause() { isPaused = !isPaused; document.getElementById('btn-pause').classList.toggle('active'); }
        function clearDb() { if(confirm("Purge local history?")) { db.transaction("logs", "readwrite").objectStore("logs").clear(); location.reload(); } }
        function refreshView() { consoleEl.innerHTML = ""; logs.forEach(renderLine); }
    </script>
</body>
</html>