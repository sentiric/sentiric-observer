<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SENTIRIC | COCKPIT PRO v3.0</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root { --primary: #00ff9d; --bg: #050505; --panel: #111; --text: #cccccc; --remote: #00d4ff; --mobile: #d900ff; --warn: #ffae00; --error: #ff4444; --sip: #00d4ff; --border: #333; }
        body { background: var(--bg); color: var(--text); font-family: 'JetBrains Mono', 'Consolas', monospace; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { background: #000; padding: 0 20px; height: 50px; border-bottom: 1px solid var(--primary); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .brand { font-weight: 800; letter-spacing: 1.5px; color: #fff; display: flex; align-items: center; gap: 10px; }
        .brand span { color: var(--primary); }
        #toolbar { background: var(--panel); padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .filter-section { display: flex; gap: 5px; align-items: center; border-right: 1px solid var(--border); padding-right: 15px; }
        .filter-section:last-child { border: none; }
        .lbl { font-size: 9px; text-transform: uppercase; color: #666; font-weight: bold; margin-right: 5px; }
        .filter-btn { background: #222; border: 1px solid #444; color: #888; padding: 4px 8px; font-size: 11px; cursor: pointer; border-radius: 3px; transition: 0.2s; min-width: 60px; text-align: center; }
        .filter-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(0, 255, 157, 0.05); }
        .action-btn { background: #333; color: var(--primary); border: 1px solid var(--primary); font-weight: bold; padding: 4px 12px; cursor: pointer; border-radius: 3px; font-size: 11px; }
        .action-btn:hover { background: var(--primary); color: #000; }
        input { background: #000; border: 1px solid #444; color: #fff; padding: 5px 10px; font-size: 12px; width: 180px; border-radius: 3px; outline: none; }
        #console { flex: 1; overflow-y: scroll; padding: 10px; background: #080808; font-size: 12px; line-height: 1.5; }
        .line { margin-bottom: 2px; padding: 4px 8px; border-bottom: 1px solid #111; white-space: pre-wrap; word-break: break-all; display: flex; gap: 10px; border-left: 3px solid transparent; }
        .ts { color: #555; min-width: 70px; }
        .node { font-weight: bold; min-width: 100px; }
        .svc { color: #aaa; min-width: 120px; }
        .msg { flex: 1; }
        .n-local { color: var(--primary); }
        .n-remote { color: var(--remote); }
        .n-mobile { color: var(--mobile); }
        .sip-box { background: #111; border: 1px solid #333; border-left: 3px solid var(--sip); padding: 8px; margin-top: 4px; border-radius: 4px; color: #888; }
        .call-id { color: var(--warn); text-decoration: underline; cursor: pointer; font-weight: bold; }
        #diagram-panel { flex: 1; background: #0e0e0e; padding: 20px; display: none; flex-direction: column; border-left: 1px solid #333; overflow: auto; }
    </style>
</head>
<body>
    <header>
        <div class="brand">SENTIRIC <span>COCKPIT PRO</span></div>
        <div id="stats-bar" style="display:flex; gap:15px; font-size:11px;">
            <div>JITTER: <span id="v-jitter" style="color:var(--primary)">--</span></div>
            <div>LOSS: <span id="v-loss" style="color:var(--primary)">0%</span></div>
        </div>
        <div id="ws-status" style="font-size:10px;">CONNECTING...</div>
    </header>

    <div id="toolbar">
        <div class="filter-section">
            <span class="lbl">NODES</span>
            <div id="filter-nodes" style="display:flex; gap:5px;"></div>
        </div>
        <div class="filter-section">
            <span class="lbl">SERVICES</span>
            <div id="filter-services" style="display:flex; gap:5px;"></div>
        </div>
        <div class="filter-section">
            <span class="lbl">TOOLS</span>
            <button class="action-btn" onclick="exportData()">AI EXPORT (JSON)</button>
            <button class="filter-btn" id="btn-pause" onclick="togglePause()">PAUSE</button>
            <input type="text" id="search" placeholder="Filter Call-ID..." oninput="refreshView()">
            <button class="filter-btn" onclick="clearDb()">PURGE DB</button>
        </div>
    </div>

    <div style="display:flex; flex:1; overflow:hidden;">
        <div id="console"></div>
        <div id="diagram-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <b style="color:var(--primary)">SEQUENCE FLOW</b>
                <button onclick="document.getElementById('diagram-panel').style.display='none'">CLOSE</button>
            </div>
            <div id="mermaid-chart"></div>
        </div>
    </div>

    <script>
        const consoleEl = document.getElementById('console');
        const wsStatus = document.getElementById('ws-status');
        
        let logs = [];
        let isPaused = false;
        let knownNodes = new Set();
        let knownServices = new Set();
        let activeNodes = new Set();
        let activeServices = new Set();

        // 1. IndexedDB Setup (Persistent History)
        const dbName = "SentiricObserverDB";
        let db;
        const request = indexedDB.open(dbName, 1);
        request.onupgradeneeded = (e) => {
            db = e.target.result;
            db.createObjectStore("logs", { autoIncrement: true });
        };
        request.onsuccess = (e) => {
            db = e.target.result;
            loadHistory();
        };

        // 2. WebSocket Connection
        const ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws`);
        ws.onopen = () => { wsStatus.innerText = '● LIVE MESH'; wsStatus.style.color = '#00ff9d'; };
        ws.onclose = () => { wsStatus.innerText = '● DISCONNECTED'; wsStatus.style.color = '#ff4444'; };

        ws.onmessage = (e) => {
            if (isPaused) return;
            try {
                const entry = JSON.parse(e.data);
                processEntry(entry, true);
            } catch (err) { console.error("Parse error", err); }
        };

        function processEntry(entry, saveToDb) {
            // Discovery
            if (!knownNodes.has(entry.node)) {
                knownNodes.add(entry.node); activeNodes.add(entry.node);
                createFilterBtn('filter-nodes', entry.node, 'node');
            }
            if (!knownServices.has(entry.service)) {
                knownServices.add(entry.service); activeServices.add(entry.service);
                createFilterBtn('filter-services', entry.service, 'svc');
            }

            logs.push(entry);
            if (logs.length > 2000) logs.shift();

            if (saveToDb && db) {
                const tx = db.transaction("logs", "readwrite");
                tx.objectStore("logs").add(entry);
            }

            renderLine(entry);
        }

        function renderLine(entry) {
            if (!activeNodes.has(entry.node) || !activeServices.has(entry.service)) return;
            const search = document.getElementById('search').value.toLowerCase();
            if (search && !JSON.stringify(entry).toLowerCase().includes(search)) return;

            const div = document.createElement('div');
            div.className = 'line';
            
            let nClass = entry.node.includes('GCP') ? 'n-remote' : (entry.node.includes('SDK') ? 'n-mobile' : 'n-local');
            div.style.borderLeftColor = `var(--${nClass.split('-')[1]})`;

            let msgHtml = entry.msg.replace(/</g, "&lt;").replace(/>/g, "&gt;")
                .replace(/(uac-[a-f0-9]+)/g, '<span class="call-id" onclick="showDiagram(\'$1\')">$1</span>');

            if (msgHtml.includes("INVITE") || msgHtml.includes("200 OK")) {
                msgHtml = `<div class="sip-box">${msgHtml}</div>`;
            }

            div.innerHTML = `
                <div class="ts">${entry.ts.split('T')[1].split('.')[0]}</div>
                <div class="node ${nClass}">${entry.node}</div>
                <div class="svc">${entry.service}</div>
                <div class="msg">${msgHtml}</div>
            `;

            consoleEl.appendChild(div);
            if (!isPaused) consoleEl.scrollTop = consoleEl.scrollHeight;
            if (consoleEl.childElementCount > 1000) consoleEl.removeChild(consoleEl.firstChild);
        }

        function createFilterBtn(containerId, name, type) {
            const btn = document.createElement('button');
            btn.innerText = name;
            btn.className = 'filter-btn active';
            btn.onclick = () => {
                const set = type === 'node' ? activeNodes : activeServices;
                set.has(name) ? set.delete(name) : set.add(name);
                btn.classList.toggle('active');
                refreshView();
            };
            document.getElementById(containerId).appendChild(btn);
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(logs, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `sentiric_logs_${new Date().getTime()}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function loadHistory() {
            const tx = db.transaction("logs", "readonly");
            const store = tx.objectStore("logs");
            store.openCursor(null, 'prev').onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor && logs.length < 500) {
                    processEntry(cursor.value, false);
                    cursor.continue();
                }
            };
        }

        function clearDb() { if(confirm("Clear browser history?")) { db.transaction("logs", "readwrite").objectStore("logs").clear(); location.reload(); } }
        function togglePause() { isPaused = !isPaused; document.getElementById('btn-pause').classList.toggle('active'); }
        function refreshView() { consoleEl.innerHTML = ""; logs.forEach(renderLine); }
        function showDiagram(id) { 
            document.getElementById('diagram-panel').style.display = 'flex';
            // Simple Diagram Gen
            let diag = "sequenceDiagram\n";
            logs.filter(l => JSON.stringify(l).includes(id)).forEach(l => {
                if (l.msg.includes("INVITE")) diag += `Mobile->>SBC: INVITE\n`;
                if (l.msg.includes("200 OK")) diag += `SBC-->>Mobile: 200 OK\n`;
            });
            document.getElementById('mermaid-chart').innerHTML = diag;
            mermaid.init(undefined, document.getElementById('mermaid-chart'));
        }
    </script>
</body>
</html>